# Proyecto Reporte SNA 2024

## Descripci贸n
Proyecto Python Backend desarrollado con Django Rest Framework para la disponibilizaci贸n de indicadores y m茅todos de verificaci贸n en evaluaci贸n ambiental.

## Organizaci贸n de Tareas
Puedes ver el backlog y la organizaci贸n de tareas en el siguiente enlace:
[Taiga Epics - Reporte SNA 2024](https://tree.taiga.io/project/paulyval-reporte-sna-2024/epics)

## Historias de Usuario
Las historias de usuario y criterios de aceptaci贸n puedes verlo en [Taiga Backlog - Reporte SNA 2024](https://tree.taiga.io/project/paulyval-reporte-sna-2024/backlog).

## Tecnolog铆as Utilizadas
- **Python**
- **Django Rest Framework**
- **PostgreSQL**
- **Taiga** (Gesti贸n de tareas)
- **drf-spectacular** (Documentaci贸n API JWT)

## Instalaci贸n y Configuraci贸n
1. **Clonar el repositorio**:
   ```bash
   git clone https://github.com/alva-ro/Reporte-SNA-2024
   ```

2. **Crear y activar entorno virtual**:
   ```bash
   python -m venv sna_env
   sna_env\Scripts\activate  # En Windows
   ```

3. **Instalar dependencias**:
   ```bash
   pip install -r requirements.txt
   ```

4. **Configurar variables de entorno**:
   Crear un archivo `.env` en la ra铆z con los siguientes campos:
   ```env
   DB_NAME=postgres
   DB_USER=postgres
   DB_PASSWORD=postgres
   DB_HOST=localhost
   DB_PORT=5432
   SECRET_KEY=tu_clave_secreta
   DEBUG=True
   ALLOWED_HOSTS=localhost,127.0.0.1
   ```

5. **Aplicar migraciones y levantar el servidor**:
   ```bash
   python manage.py migrate
   python manage.py runserver
   ```

## Autenticaci贸n JWT
Para autenticarse y probar endpoints protegidos:

1. Obtener el token:
   ```http
   POST /api/token/
   {
     "username": "tu_usuario",
     "password": "tu_password"
   }
   ```

2. Usar el token en cada petici贸n:
   ```http
   Authorization: Bearer <tu_token>
   ```

## Roles y Permisos

El sistema implementa control de acceso basado en roles, mediante clases personalizadas:

| Rol                        | Permisos                                                                 |
|---------------------------|--------------------------------------------------------------------------|
| `EsRepOrgResOSoloLectura` | Puede listar y crear reportes. No puede modificar ni eliminar.           |
| `EsAdminOSoloLectura`     | Puede modificar el estado de un reporte, eliminar si es necesario.       |
| `EsSuperAdminOSoloLectura`| Tiene acceso total a todos los recursos, incluyendo configuraci贸n.       |

Estos roles se validan en cada endpoint mediante `permission_classes` personalizadas.

## Carga de datos de prueba

Para probar la paginaci贸n y filtros de reportes, puedes ejecutar el siguiente script que carga reportes demo en la base de datos:

1. Aseg煤rate de tener al menos:
   - Una medida creada.
   - Dos organismos responsables creados.

2. Activa el entorno virtual:

   - En **Bash**:
     ```bash
     source .venv/Scripts/activate
     ```

   - En **PowerShell**:
     ```powershell
     .venv\Scripts\activate
     ```

3. Ejecuta el shell de Django y corre el script:

   ```bash
   python manage.py shell
   ```

   Dentro del shell:

   ```python
   exec(open('scripts/cargar_reportes_demo.py', encoding='utf-8').read())
   ```

4. Verifica que se hayan cargado correctamente:

   ```python
   from app_reporte.models import Reporte
   print("Reportes creados:", Reporte.objects.count())
   ```

> Este script crea 20 reportes aleatorios con fechas, estados y relaciones reales. Es 煤til para probar filtros, paginaci贸n y trazabilidad de cambios de estado.

> Tambi茅n puedes modificarlo para ajustar la cantidad de datos generados o simular combinaciones espec铆ficas de filtros y estados.

## API Endpoints

###  Regiones

#### Listado de Regiones
`GET /api/regiones/`

Lista todas las regiones disponibles con filtrado opcional por nombre.

##### Par谩metros de consulta disponibles:
| Par谩metro | Tipo   | Descripci贸n                                    | Ejemplo                  |
|-----------|--------|------------------------------------------------|--------------------------|
| `nombre`  | str    | Filtrar por nombre (b煤squeda parcial)          | `nombre=metropolitana`   |

##### Ejemplo de respuesta:
```json
[
  {
    "id": 1,
    "nombre": "Regi贸n Metropolitana"
  }
]
```

#### Operaciones CRUD de Regiones

| M茅todo | Ruta                    | Descripci贸n                      |
|--------|-------------------------|----------------------------------|
| POST   | `/api/regiones/`        | Crear una nueva regi贸n           |
| GET    | `/api/regiones/{id}/`   | Obtener detalle de una regi贸n    |
| PUT    | `/api/regiones/{id}/`   | Actualizar una regi贸n existente  |
| DELETE | `/api/regiones/{id}/`   | Eliminar una regi贸n existente    |

###  Ciudades

#### Listado de Ciudades
`GET /api/ciudades/`

Lista todas las ciudades con filtrado por nombre, regi贸n ID o nombre de regi贸n.

##### Par谩metros de consulta disponibles:
| Par谩metro      | Tipo   | Descripci贸n                                    | Ejemplo                       |
|----------------|--------|------------------------------------------------|-------------------------------|
| `nombre`       | str    | Filtrar por nombre (b煤squeda parcial)          | `nombre=santiago`             |
| `region_id`    | int    | Filtrar por ID de regi贸n                       | `region_id=1`                 |
| `region_nombre`| str    | Filtrar por nombre de regi贸n                   | `region_nombre=metropolitana` |

##### Ejemplo de respuesta:
```json
[
  {
    "id": 1,
    "nombre": "Santiago",
    "region": 1
  }
]
```

#### Operaciones CRUD de Ciudades

| M茅todo | Ruta                    | Descripci贸n                      |
|--------|-------------------------|----------------------------------|
| POST   | `/api/ciudades/`        | Crear una nueva ciudad           |
| GET    | `/api/ciudades/{id}/`   | Obtener detalle de una ciudad    |
| PUT    | `/api/ciudades/{id}/`   | Actualizar una ciudad existente  |
| DELETE | `/api/ciudades/{id}/`   | Eliminar una ciudad existente    |

###  Comunas

#### Listado de Comunas
`GET /api/comunas/`

Lista todas las comunas con filtrado por nombre, ciudad ID o nombre de ciudad.

##### Par谩metros de consulta disponibles:
| Par谩metro      | Tipo   | Descripci贸n                                    | Ejemplo                  |
|----------------|--------|------------------------------------------------|--------------------------|
| `nombre`       | str    | Filtrar por nombre (b煤squeda parcial)          | `nombre=santiago`        |
| `ciudad_id`    | int    | Filtrar por ID de ciudad                       | `ciudad_id=1`            |
| `ciudad_nombre`| str    | Filtrar por nombre de ciudad                   | `ciudad_nombre=santiago` |

##### Ejemplo de respuesta:
```json
[
  {
    "id": 1,
    "nombre": "Santiago Centro",
    "ciudad": 1
  }
]
```

#### Operaciones CRUD de Comunas

| M茅todo | Ruta                    | Descripci贸n                      |
|--------|-------------------------|----------------------------------|
| POST   | `/api/comunas/`         | Crear una nueva comuna           |
| GET    | `/api/comunas/{id}/`    | Obtener detalle de una comuna    |
| PUT    | `/api/comunas/{id}/`    | Actualizar una comuna existente  |
| DELETE | `/api/comunas/{id}/`    | Eliminar una comuna existente    |

###  Planes PPDA

#### Listado de Planes PPDA
`GET /api/planes/`

Lista todos los planes PPDA con filtrado por nombre, mes, a帽o y comuna.

##### Par谩metros de consulta disponibles:
| Par谩metro      | Tipo   | Descripci贸n                                    | Ejemplo                  |
|----------------|--------|------------------------------------------------|--------------------------|
| `nombre`       | str    | Filtrar por nombre (b煤squeda parcial)          | `nombre=descontaminacion`|
| `mes_reporte`  | int    | Filtrar por mes de reporte (1-12)              | `mes_reporte=6`          |
| `anio`         | int    | Filtrar por a帽o                                | `anio=2024`              |
| `comuna_id`    | int    | Filtrar por ID de comuna                       | `comuna_id=1`            |

##### Ejemplo de respuesta:
```json
[
  {
    "id": 1,
    "nombre": "Plan de Descontaminaci贸n",
    "anio": 2024,
    "mes_reporte": 6,
    "comunas": [1, 2, 3]
  }
]
```

#### Operaciones CRUD de Planes PPDA

| M茅todo | Ruta                    | Descripci贸n                      |
|--------|-------------------------|----------------------------------|
| POST   | `/api/planes/`          | Crear un nuevo plan PPDA         |
| GET    | `/api/planes/{id}/`     | Obtener detalle de un plan PPDA  |
| PUT    | `/api/planes/{id}/`     | Actualizar un plan PPDA existente|
| DELETE | `/api/planes/{id}/`     | Eliminar un plan PPDA existente  |

###  Organismos Responsables

#### Listado de Organismos Responsables
`GET /api/organismo-responsable/`

Lista todos los organismos responsables con filtrado por nombre.

##### Par谩metros de consulta disponibles:
| Par谩metro | Tipo   | Descripci贸n                                    | Ejemplo                  |
|-----------|--------|------------------------------------------------|--------------------------|
| `nombre`  | str    | Filtrar por nombre (b煤squeda parcial)          | `nombre=ministerio`      |

##### Ejemplo de respuesta:
```json
[
  {
    "id": 1,
    "nombre": "Ministerio del Medio Ambiente"
  }
]
```

#### Operaciones CRUD de Organismos Responsables

| M茅todo | Ruta                               | Descripci贸n                      |
|--------|------------------------------------|----------------------------------|
| POST   | `/api/organismo-responsable/`      | Crear un nuevo organismo         |
| GET    | `/api/organismo-responsable/{id}/` | Obtener detalle de un organismo  |
| PUT    | `/api/organismo-responsable/{id}/` | Actualizar un organismo existente|
| DELETE | `/api/organismo-responsable/{id}/` | Eliminar un organismo existente  |

###  Medidas

#### Listado de Medidas
`GET /api/medidas/`

Lista todas las medidas con filtrado por nombre corto, referencia PDA, plan y organismo.

##### Par谩metros de consulta disponibles:
| Par谩metro       | Tipo   | Descripci贸n                                    | Ejemplo                   |
|-----------------|--------|------------------------------------------------|---------------------------|
| `nombre_corto`  | str    | Filtrar por nombre corto                       | `nombre_corto=reduccion`  |
| `referencia_pda`| str    | Filtrar por referencia PDA                     | `referencia_pda=PPDA-2024`|
| `plan_id`       | int    | Filtrar por ID de plan                         | `plan_id=1`               |
| `organismo_id`  | int    | Filtrar por ID de organismo                    | `organismo_id=2`          |

##### Ejemplo de respuesta:
```json
[
  {
    "id": 1,
    "nombre_corto": "Reducci贸n de emisiones",
    "referencia_pda": "PPDA-2024-001",
    "plan": 1,
    "organismos": [1, 2]
  }
]
```

#### Operaciones CRUD de Medidas

| M茅todo | Ruta                    | Descripci贸n                      |
|--------|-------------------------|----------------------------------|
| POST   | `/api/medidas/`         | Crear una nueva medida           |
| GET    | `/api/medidas/{id}/`    | Obtener detalle de una medida    |
| PUT    | `/api/medidas/{id}/`    | Actualizar una medida existente  |
| DELETE | `/api/medidas/{id}/`    | Eliminar una medida existente    |

### Notas Generales
- Las b煤squedas por nombre son:
  - Parciales (contienen el texto buscado)
  - No distinguen entre may煤sculas y min煤sculas
  - Ignoran tildes y acentos

## Reportes

Los siguientes endpoints permiten gestionar reportes asociados a medidas de los planes PPDA, incluyendo su creaci贸n, actualizaci贸n, validaci贸n y trazabilidad de estados.

###  Listado de Reportes
`GET /api/reportes/`

Este endpoint permite listar los reportes disponibles aplicando filtros opcionales y control de paginaci贸n.

#### Par谩metros de consulta disponibles:
| Par谩metro      | Tipo   | Descripci贸n                                               | Ejemplo                  |
|----------------|--------|-----------------------------------------------------------|--------------------------|
| `organismo`    | int    | ID del organismo responsable                              | `organismo=2`            |
| `estado`       | str    | Estado del reporte (`pendiente`, `aprobado`, `rechazado`) | `estado=pendiente`       |
| `fecha_envio`  | str    | Fecha de env铆o exacta en formato `YYYY-MM-DD`             | `fecha_envio=2024-04-01` |
| `ordering`     | str    | Campo por el que ordenar (`fecha_envio`, `estado`)        | `ordering=-fecha_envio`  |
| `page`         | int    | N煤mero de p谩gina                                          | `page=2`                 |
| `page_size`    | int    | Cantidad de resultados por p谩gina                         | `page_size=20`           |

> Los resultados son paginados autom谩ticamente para mejorar el rendimiento.

---

###  Modificaci贸n de Estado
`PUT /api/reportes/{id_reporte}/estado/`

Permite actualizar el estado de un reporte validando las siguientes reglas:
- No se puede aprobar un reporte que ha sido rechazado.
- No se puede modificar un reporte que ya ha sido aprobado.

Cada cambio queda registrado en un historial de trazabilidad (`HistorialEstadoReporte`) con:
- Estado anterior
- Estado nuevo
- Usuario responsable
- Fecha del cambio

---

###  Operaciones CRUD de un Reporte

| M茅todo | Ruta                          | Descripci贸n                      |
|--------|-------------------------------|----------------------------------|
| POST   | `/api/reporte/`               | Crear un nuevo reporte           |
| GET    | `/api/reporte/{id_reporte}`   | Obtener detalle de un reporte    |
| PUT    | `/api/reporte/{id_reporte}`   | Actualizar un reporte existente  |
| DELETE | `/api/reporte/{id_reporte}`   | Eliminar un reporte existente    |

---

###  Ejemplo de respuesta con paginaci贸n:
```json
{
  "count": 45,
  "next": "http://localhost:8000/api/reportes/?page=1",
  "previous": null,
  "results": [
    {
      "id": 1,
      "estado": "pendiente",
      "organismo": 2,
      "fecha_envio": "2024-04-01",
      "descripcion": "Avance preliminar"
    }
  ]
}
```

### Permisos aplicados
- `EsRepOrgResOSoloLectura`: Solo puede listar, ver y crear.
- `EsAdminOSoloLectura`: Puede modificar el estado o eliminar.

---

## Informaci贸n entrega 2
En esta segunda entrega nuestro foco principal fue integrar seguridad a nuestros endpoints a trav茅s de token JWT, asignando roles y permisos para controlar los accesos. 

## Pr贸ximos pasos
1. Documentar el proceso de autenticaci贸n y autorizaci贸n para los administradores.
2. Crear nuevos endpoints para mejorar las opciones de filtrados.
3. Integrar rate limiting.
4. Fortalecer validaciones en endpoints cr铆ticos.
5. Agregar trazabilidad completa al historial de cambios.
6. Incorporar tests autom谩ticos.

Para m谩s detalles, consulta la documentaci贸n en:
```
http://127.0.0.1:8000/api/docs/#/
```

